# ocean_worktree remove - Remove a git worktree and its branch
# Usage: owremove <directory-name>

# Check if we're in the correct directory
local current_dir expected_dir
current_dir=$(realpath "$PWD" 2>/dev/null) || current_dir="$PWD"
expected_dir=$(realpath "/Users/nartc/code/github/nrwl/ocean" 2>/dev/null) || expected_dir="/Users/nartc/code/github/nrwl/ocean"

if [[ "$current_dir" != "$expected_dir" ]]; then
  echo "Error: This command must be run from /Users/nartc/code/github/nrwl/ocean"
  return 1
fi

if [[ $# -ne 1 ]]; then
  echo "Usage: owremove <directory-name>"
  echo "Example: owremove my-feature"
  return 1
fi

local directory_name="$1"
local worktree_path="../ocean-worktrees/${directory_name}"

# Check if worktree exists
if [[ ! -d "$worktree_path" ]]; then
  echo "Error: Worktree directory ${worktree_path} does not exist"
  return 1
fi

echo "Removing worktree: ${worktree_path}"

# Get the branch name associated with this worktree
local branch_name
branch_name=$(git worktree list --porcelain | awk -v path="$(realpath "$worktree_path")" '
  $1 == "worktree" && $2 == path { getline; if ($1 == "branch") print substr($0, 8) }')

if [[ -z "$branch_name" ]]; then
  echo "Warning: Could not determine branch name for worktree"
else
  echo "Associated branch: ${branch_name}"
fi

# Remove the worktree with git
echo "Removing git worktree..."
git worktree remove "$worktree_path"

# If we got the branch name, try to remove the local branch
if [[ -n "$branch_name" ]]; then
  echo "Removing local branch: ${branch_name}"
  git branch -D "$branch_name" 2>/dev/null || echo "Warning: Could not remove branch ${branch_name} (may not exist or may be current branch)"
fi

# Check if worktree directory still exists (e.g., editor still has it open)
if [[ -d "$worktree_path" ]]; then
  echo "Warning: Worktree directory still exists. Force removing..."
  rm -rf "$worktree_path"
  if [[ $? -eq 0 ]]; then
    echo "  ✓ Successfully removed directory"
  else
    echo "  ✗ Failed to remove directory. You may need to close any editors and remove manually."
    return 1
  fi
fi

echo "Worktree ${directory_name} removed successfully"
