{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash

set -e

# ─────────────────────────────────────────────
# Folder Setup
# ─────────────────────────────────────────────
mkdir -p ~/code/github ~/code/sandbox ~/Desktop/screenshots

# ─────────────────────────────────────────────
# Security & Power
# ─────────────────────────────────────────────
# Ask for admin password upfront
sudo -v
# Keep-alive: update sudo timestamp
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# Set standby delay to 24 hours (default is 1 hour)
sudo pmset -a standbydelay 86400

# Disable "Are you sure you want to open this application?" dialog
defaults write com.apple.LaunchServices LSQuarantine -bool false

# Require password immediately after sleep or screen saver
defaults write com.apple.screensaver askForPassword -int 1
defaults write com.apple.screensaver askForPasswordDelay -int 0

# ─────────────────────────────────────────────
# Dock
# ─────────────────────────────────────────────
defaults write com.apple.dock tilesize -int 42
defaults write com.apple.dock magnification -bool true
defaults write com.apple.dock largesize -int 54
defaults write com.apple.dock autohide -bool true
defaults write com.apple.dock minimize-to-application -bool true
defaults write com.apple.dock autohide-time-modifier -float 0.5
defaults write com.apple.dock autohide-delay -float 0
defaults write com.apple.dock show-process-indicators -bool true
defaults write com.apple.dock show-recents -bool false

# ─────────────────────────────────────────────
# Keyboard
# ─────────────────────────────────────────────
# Disable press-and-hold for character popup
defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false
# Fastest key repeat
defaults write NSGlobalDomain KeyRepeat -int 1
defaults write NSGlobalDomain InitialKeyRepeat -int 10
# Enable Tab in modal dialogs
defaults write NSGlobalDomain AppleKeyboardUIMode -int 3

# ─────────────────────────────────────────────
# Text Input
# ─────────────────────────────────────────────
# Disable auto-correct
defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false
# Disable auto-capitalize
defaults write NSGlobalDomain NSAutomaticCapitalizationEnabled -bool false
# Disable smart quotes
defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false
# Disable smart dashes
defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false
# Disable period with double-space
defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool false

# ─────────────────────────────────────────────
# Trackpad
# ─────────────────────────────────────────────
# Tap to click
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
# Three-finger drag
defaults write com.apple.AppleMultitouchTrackpad TrackpadThreeFingerDrag -bool true
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadThreeFingerDrag -bool true

# ─────────────────────────────────────────────
# Mission Control
# ─────────────────────────────────────────────
# Don't auto-rearrange Spaces based on most recent use
defaults write com.apple.dock mru-spaces -bool false
# Speed up Mission Control animations
defaults write com.apple.dock expose-animation-duration -float 0.1

# ─────────────────────────────────────────────
# Menu Bar
# ─────────────────────────────────────────────
# Always show menu bar (not auto-hide)
defaults write NSGlobalDomain _HIHideMenuBar -bool false
# Show battery percentage
defaults write com.apple.menuextra.battery ShowPercent -string "YES"

# ─────────────────────────────────────────────
# Sound
# ─────────────────────────────────────────────
# Disable startup chime
sudo nvram StartupMute=%01
# Disable UI sound effects
defaults write NSGlobalDomain com.apple.sound.uiaudio.enabled -int 0
# Keep volume change feedback (commented out to keep it)
# defaults write NSGlobalDomain com.apple.sound.beep.feedback -int 0

# ─────────────────────────────────────────────
# Safari
# ─────────────────────────────────────────────
# Enable Develop menu
defaults write com.apple.Safari IncludeDevelopMenu -bool true 2>/dev/null || true
defaults write com.apple.Safari WebKitDeveloperExtrasEnabledPreferenceKey -bool true 2>/dev/null || true
# Show full URL in address bar
defaults write com.apple.Safari ShowFullURLInSmartSearchField -bool true 2>/dev/null || true
# Don't auto-open "safe" downloads
defaults write com.apple.Safari AutoOpenSafeDownloads -bool false 2>/dev/null || true

# ─────────────────────────────────────────────
# Window Animations
# ─────────────────────────────────────────────
# Speed up window resize animation
defaults write NSGlobalDomain NSWindowResizeTime -float 0.001

# ─────────────────────────────────────────────
# Security
# ─────────────────────────────────────────────
# Enable firewall
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on
# Note: Remote login (SSH) left enabled

# ─────────────────────────────────────────────
# Bluetooth
# ─────────────────────────────────────────────
# Show Bluetooth in menu bar
defaults write com.apple.controlcenter "NSStatusItem Visible Bluetooth" -bool true

# ─────────────────────────────────────────────
# Finder
# ─────────────────────────────────────────────
defaults write NSGlobalDomain AppleShowAllExtensions -bool true
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"
defaults write com.apple.finder ShowPathbar -bool true
defaults write com.apple.finder ShowStatusBar -bool true
defaults write com.apple.finder DisableAllAnimations -bool true
defaults write com.apple.finder ShowExternalHardDrivesOnDesktop -bool true
defaults write com.apple.finder ShowHardDrivesOnDesktop -bool true
defaults write com.apple.finder ShowMountedServersOnDesktop -bool true
defaults write com.apple.finder ShowRemovableMediaOnDesktop -bool true
defaults write com.apple.finder AppleShowAllFiles -bool true
defaults write com.apple.finder _FXShowPosixPathInTitle -bool true
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false

# Avoid .DS_Store on network/USB volumes
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true

# ─────────────────────────────────────────────
# Screenshots
# ─────────────────────────────────────────────
defaults write com.apple.screencapture location ~/Desktop/screenshots && killall SystemUIServer

# ─────────────────────────────────────────────
# Apply changes
# ─────────────────────────────────────────────
for app in "Dock" "Finder"; do
    killall "${app}" >/dev/null 2>&1
done

echo "Done. Note that some of these changes require a logout/restart to take effect."
{{ end -}}
